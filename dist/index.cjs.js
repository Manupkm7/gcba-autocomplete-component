"use strict";var e=require("react/jsx-runtime"),s=require("react"),r=require("axios");const t="https://servicios.usig.buenosaires.gob.ar";class a{debug;maxSuggestions;lastRequest;serverTimeout;constructor(e={}){this.debug=e.debug||!1,this.maxSuggestions=e.maxSuggestions||10,this.serverTimeout=e.serverTimeout||5e3,this.lastRequest=null}abort(){this.lastRequest&&(this.lastRequest.abort(),this.lastRequest=null,this.debug&&console.log("Request aborted"))}async normalizar(e,s=this.maxSuggestions){this.debug&&console.log(`ApiNormalizer.normalizar('${e}', ${s})`),this.abort(),this.lastRequest=new AbortController;try{let r=[];const t=await this.searchAddresses(e,s);r=[...r,...t];const a=this.parseCoordinates(e);if(a){const e=await this.reverseGeocode(a.x,a.y);r=[...r,...e]}return r.slice(0,s)}catch(e){return r.isCancel(e)?this.debug&&console.log("Request was cancelled"):console.error("Error normalizing address:",e),[]}finally{this.lastRequest=null}}async searchAddresses(e,s){try{const a=`${t}/normalizar/?direccion=${encodeURIComponent(e)}&geocodificar=true&max=${s}`,o={headers:{Accept:"application/json"},signal:this.lastRequest?.signal,timeout:this.serverTimeout},i=await r.get(a,o);return i.data.error?(this.debug&&console.error("API error:",i.data.error),[]):i.data.direccionesNormalizadas&&i.data.direccionesNormalizadas.length>0?this.processDireccionesNormalizadas(i.data.direccionesNormalizadas):i.data.calles&&i.data.calles.length>0?this.processCalles(i.data.calles):[]}catch(e){return r.isCancel(e)?this.debug&&console.log("Address search request was cancelled"):console.error("Error searching addresses:",e),[]}}parseCoordinates(e){const s=e.trim().replace(/\s+/g,""),r=[/^(-?\d+\.?\d*),(-?\d+\.?\d*)$/,/x:?(-?\d+\.?\d*)[,\s]+y:?(-?\d+\.?\d*)/i,/y:?(-?\d+\.?\d*)[,\s]+x:?(-?\d+\.?\d*)/i];for(const e of r){const t=s.match(e);if(t){if(e===r[0])return{y:Number.parseFloat(t[1]),x:Number.parseFloat(t[2])};if(e===r[1])return{x:Number.parseFloat(t[1]),y:Number.parseFloat(t[2])};if(e===r[2])return{y:Number.parseFloat(t[1]),x:Number.parseFloat(t[2])}}}return null}async reverseGeocode(e,s){this.debug&&console.log(`ApiNormalizer.reverseGeocode(${e}, ${s})`),this.abort(),this.lastRequest=new AbortController;try{const a=`${t}/reverseGeocoderLugares/?x=${e}&y=${s}&srid=4326`,o={headers:{Accept:"application/json"},signal:this.lastRequest.signal,timeout:this.serverTimeout},i=await r.get(a,o);if(i.data.error)return this.debug&&console.error("Reverse geocoding API error:",i.data.error),[];if(!i.data.direccion)return[];const c={codigo:i.data.cod_calle||"coord",nombre:i.data.nombre||i.data.direccion||"Coordenada",descripcion:i.data.direccion||"Coordenada",tipo:"CALLE",alturas:[{inicio:1,fin:1e4}]};let n=0;i.data.altura&&(n=Number.parseInt(i.data.altura,10));return[{calle:c,altura:n||1,tipoDireccion:"DIRECCION_CALLE_ALTURA",tipo:"DIRECCION",nombre:i.data.direccion||`Coordenada (${e.toFixed(6)}, ${s.toFixed(6)})`,descripcion:`Coordenada (${e.toFixed(6)}, ${s.toFixed(6)})`,coordenadas:{x:e,y:s,srid:i.data.coordenadas?.srid||4326}}]}catch(e){return r.isCancel(e)?this.debug&&console.log("Reverse geocoding request was cancelled"):console.error("Error in reverse geocoding:",e),[]}finally{this.lastRequest=null}}processDireccionesNormalizadas(e){if(!e)return Promise.resolve([]);const s=e.map((async e=>{if(!e.direccion||!e.cod_calle)return null;const s={codigo:e.cod_calle,nombre:e.nombre||e.direccion.split(" ")[0],descripcion:e.direccion,tipo:"CALLE",alturas:[{inicio:1,fin:1e4}]};let r;if(e.direccion.includes(" y ")){const t=e.direccion.split(" y ").map((e=>e.trim()));r={calle:s,calleCruce:{codigo:`${e.cod_calle}_cruce`,nombre:t[1]||"Calle cruce",descripcion:t[1]||"Calle cruce",tipo:"CALLE",alturas:[{inicio:1,fin:1e4}]},tipoDireccion:"DIRECCION_CALLE_Y_CALLE",tipo:"DIRECCION",nombre:e.direccion,descripcion:e.direccion,coordenadas:e.coordenadas?{x:Number.parseFloat(e.coordenadas.x),y:Number.parseFloat(e.coordenadas.y),srid:e.coordenadas.srid}:void 0}}else{const t=e.altura?Number.parseInt(e.altura,10):0;if(r={calle:s,altura:t,tipoDireccion:"DIRECCION_CALLE_ALTURA",tipo:"DIRECCION",nombre:e.direccion,descripcion:e.direccion,coordenadas:e.coordenadas?{x:Number.parseFloat(e.coordenadas.x),y:Number.parseFloat(e.coordenadas.y),srid:e.coordenadas.srid}:void 0},t>0)try{const s=await this.getSMP({nombre:e.direccion,descripcion:e.direccion||"",tipo:"DIRECCION",codigo:e.cod_calle,altura:e.altura,calle:{codigo:e.cod_calle}});s&&(r.smp=s)}catch(e){this.debug&&console.error("Error getting SMP:",e)}}return r}));return Promise.all(s).then((e=>e.filter(Boolean)))}processCalles(e){return e?e.map((e=>({codigo:e.cod_calle,nombre:e.nombre,descripcion:e.tipo?`${e.tipo} ${e.nombre}`:e.nombre,tipo:"CALLE",alturas:[{inicio:e.altura?.inicial||1,fin:e.altura?.final||1e4}],partido:e.partido,localidad:e.localidad}))):[]}async getCoordinates(e){try{this.abort(),this.lastRequest=new AbortController;const s=`${t}/normalizar/?direccion=${encodeURIComponent(e.nombre)},${encodeURIComponent(e.descripcion)}&geocodificar=true&srid=4326`,a={headers:{Accept:"application/json"},signal:this.lastRequest.signal,timeout:this.serverTimeout},o=await r.get(s,a),i=o.data.direccionesNormalizadas?.[0];if(i?.coordenadas){const e=i.coordenadas;return{x:Number.parseFloat(e.x),y:Number.parseFloat(e.y),srid:e.srid}}return}catch(e){return void(r.isCancel(e)?this.debug&&console.debug("Request was aborted"):console.error("Error fetching coordinates:",e))}finally{this.lastRequest=null}}async getSMP(e){try{this.abort(),this.lastRequest=new AbortController;const s=e.codigo||e.calle?.codigo;if(!s||!e.altura)return;const t=`https://epok.buenosaires.gob.ar/catastro/parcela/?codigo_calle=${encodeURIComponent(s)}&altura=${encodeURIComponent(String(e.altura))}&geocodificar=true&srid=4326`,a={headers:{Accept:"application/json"},signal:this.lastRequest.signal,timeout:this.serverTimeout};return(await r.get(t,a)).data.smp}catch(e){return void(r.isCancel(e)?this.debug&&console.log("Request was aborted"):console.error("Error fetching catastro data:",e))}finally{this.lastRequest=null}}static inicializado(){return!0}}const o=({className:s="",size:r=24,color:t="currentColor"})=>e.jsx("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",stroke:t,strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:s,children:e.jsx("path",{d:"M21 12a9 9 0 1 1-6.219-8.56"})}),i=({className:s="",size:r=24,color:t="currentColor"})=>e.jsx("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",stroke:t,strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:s,children:e.jsx("polygon",{points:"3,11 22,2 13,21 11,13 3,11"})});exports.AddressSearch=({maxSuggestions:r=10,onAddressSelect:t,onAddressesChange:c,placeholder:n="Buscar dirección o coordenadas...",debug:l=!1,className:d="",inputClassName:u="",suggestionsClassName:m="",suggestionItemClassName:g="",selectedAddressesClassName:p="",loadingClassName:h="",suggestionsContainerClassName:x="",selectedAddressesContainerClassName:b="",selectedAddressItemClassName:C="",removeButtonClassName:N="",errorClassName:y="",iconClassName:f="",titleClassName:v="",subtitleClassName:A="",coordsClassName:$="",smpClassName:j="",serverTimeout:L=5e3})=>{const[R,E]=s.useState(""),[S,w]=s.useState([]),[I,T]=s.useState([]),[q,D]=s.useState(!1),[F,_]=s.useState(!1),[z,k]=s.useState(null),B=s.useRef(null),O=s.useRef(null);s.useEffect((()=>(O.current=new a({debug:l,maxSuggestions:r,serverTimeout:L}),()=>{B.current&&clearTimeout(B.current),O.current&&O.current.abort()})),[l,r,L]);const P=e=>"CALLE"===e.tipo?{title:e.nombre,subTitle:e.descripcion||"CABA",type:"CALLE",category:"CALLE",suggesterName:"Direcciones",data:{nombre:e.nombre,descripcion:e.descripcion||"",tipo:"CALLE",codigo:e.codigo}}:{title:e.nombre,subTitle:e.descripcion||"CABA",type:e.tipoDireccion,category:e.tipoDireccion,suggesterName:"Direcciones",data:{nombre:e.nombre,descripcion:e.descripcion||"",tipo:e.tipo,codigo:e.calle.codigo,altura:"DIRECCION_CALLE_ALTURA"===e.tipoDireccion?e.altura:void 0,calle:{codigo:e.calle.codigo},coordenadas:e.coordenadas,smp:e.smp}},U=s.useCallback((async e=>{if(l&&console.log(`getSuggestions('${e}')`),!O.current||!e||e.length<3)w([]);else try{D(!0),k(null);const s=(await O.current.normalizar(e,r)).map(P);w(s),_(!0),0===s.length&&k("No se encontraron resultados")}catch(e){console.error("Error getting suggestions:",e),w([]),k("Error al buscar direcciones")}finally{D(!1)}}),[l,r]);return e.jsxs("div",{className:`address-search-container ${d}`,children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:R,onChange:e=>{const s=e.target.value;E(s),k(null),B.current&&clearTimeout(B.current),O.current&&O.current.abort(),s.length>=3?(_(!0),D(!0),B.current=setTimeout((()=>{U(s)}),300)):(w([]),_(!1),D(!1))},onFocus:()=>{R.length>=3&&_(!0)},onBlur:()=>{setTimeout((()=>{_(!1)}),200)},placeholder:n,className:`w-full p-2 border rounded ${u}`}),q&&e.jsx("div",{className:`absolute right-2 top-1/2 transform -translate-y-1/2 ${h}`,children:e.jsx(o,{className:"h-4 w-4 text-gray-500 animate-spin"})}),(F||q)&&e.jsx("ul",{className:`absolute z-10 w-full mt-1 bg-white border rounded shadow-lg max-h-60 overflow-auto ${x}`,children:q?e.jsxs("li",{className:`p-4 text-center text-gray-500 ${m}`,children:[e.jsx(o,{className:"h-5 w-5 mx-auto animate-spin mb-2"}),e.jsx("span",{children:"Buscando direcciones..."})]}):S.length>0?S.map(((s,r)=>e.jsx("li",{className:`p-2 cursor-pointer hover:bg-gray-100 ${g}`,onClick:()=>(e=>{if(!I.some((s=>s.data.nombre===e.data.nombre))){const s=[...I,e];T(s),t&&t(e),c&&c(s)}E(""),w([]),_(!1)})(s),children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"mt-1",children:e.jsx(i,{className:`h-4 w-4 text-blue-500 ${f}`})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:`font-medium ${v}`,children:s.title}),e.jsx("div",{className:`text-sm text-gray-500 ${A}`,children:s.subTitle}),s.data.coordenadas&&e.jsxs("div",{className:`text-xs text-gray-400 ${$}`,children:["Coord: ",s.data.coordenadas.x.toFixed(6),","," ",s.data.coordenadas.y.toFixed(6)]}),s.data.smp&&e.jsxs("div",{className:`text-xs text-gray-400 ${j}`,children:["SMP: ",s.data.smp]})]})]})},`${s.data.nombre}-${r}`))):R.length>=3?e.jsx("li",{className:`p-4 text-center text-red-500 ${y}`,children:z||"No se encontraron resultados"}):e.jsx("li",{className:`p-4 text-center text-gray-500 ${m}`,children:"Ingrese al menos 3 caracteres para buscar"})}),z&&!q&&!F&&e.jsx("div",{className:`mt-1 text-sm text-red-500 ${y}`,children:z})]}),I.length>0&&e.jsxs("div",{className:`mt-4 ${p} ${b}`,children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"Direcciones seleccionadas:"}),e.jsx("ul",{className:"space-y-2",children:I.map(((s,r)=>e.jsxs("li",{className:`flex justify-between items-center p-2 bg-gray-50 rounded ${C}`,children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"mt-1",children:e.jsx(i,{className:`h-4 w-4 text-blue-500 ${f}`})}),e.jsxs("div",{children:[e.jsx("div",{className:`font-medium ${v}`,children:s.title}),e.jsx("div",{className:`text-sm text-gray-500 ${A}`,children:s.subTitle}),s.data.coordenadas&&e.jsxs("div",{className:`text-xs text-gray-400 ${$}`,children:["Coord: ",s.data.coordenadas.x.toFixed(6),","," ",s.data.coordenadas.y.toFixed(6)]}),s.data.smp&&e.jsxs("div",{className:`text-xs text-gray-400 ${j}`,children:["SMP: ",s.data.smp]})]})]}),e.jsx("button",{type:"button",onClick:()=>(e=>{const s=[...I];s.splice(e,1),T(s),c&&c(s)})(r),className:`text-red-500 hover:text-red-700 ${N}`,children:"×"})]},`selected-${r}`)))})]})]})},exports.useAddressSearch=function(e={}){const{maxSuggestions:r=10,debug:t=!1,serverTimeout:o=5e3}=e,[i,c]=s.useState(""),[n,l]=s.useState([]),[d,u]=s.useState([]),[m,g]=s.useState(!1),[p,h]=s.useState(null),[x,b]=s.useState(!1),C=s.useRef(null),N=s.useRef(null);s.useEffect((()=>(N.current=new a({debug:t,maxSuggestions:r,serverTimeout:o}),()=>{C.current&&clearTimeout(C.current),N.current&&N.current.abort()})),[t,r,o]);const y=e=>"CALLE"===e.tipo?{title:e.nombre,subTitle:e.descripcion||"CABA",type:"CALLE",category:"CALLE",suggesterName:"Direcciones",data:{nombre:e.nombre,descripcion:e.descripcion||"",tipo:"CALLE",codigo:e.codigo}}:{title:e.nombre,subTitle:e.descripcion||"CABA",type:e.tipoDireccion,category:e.tipoDireccion,suggesterName:"Direcciones",data:{nombre:e.nombre,descripcion:e.descripcion||"",tipo:e.tipo,codigo:e.calle.codigo,altura:"DIRECCION_CALLE_ALTURA"===e.tipoDireccion?e.altura:void 0,calle:{codigo:e.calle.codigo},coordenadas:e.coordenadas,smp:e.smp}},f=s.useCallback((async e=>{if(t&&console.log(`fetchSuggestions('${e}')`),!N.current||!e||e.length<3)l([]);else try{g(!0),h(null);const s=(await N.current.normalizar(e,r)).map(y);l(s),0===s.length&&h("No se encontraron resultados")}catch(e){console.error("Error getting suggestions:",e),l([]),h("Error al buscar direcciones")}finally{g(!1)}}),[t,r]);return{searchText:i,setSearchText:c,suggestions:n,selectedAddresses:d,isLoading:m,error:p,showSuggestions:x,setShowSuggestions:b,handleInputChange:e=>{const s=e.target.value;c(s),h(null),C.current&&clearTimeout(C.current),N.current&&N.current.abort(),s.length>=3?C.current=setTimeout((()=>{f(s)}),300):l([])},handleSelectSuggestion:e=>{d.some((s=>s.data.nombre===e.data.nombre))||u((s=>[...s,e])),c(""),l([]),b(!1)},handleRemoveAddress:e=>{u((s=>{const r=[...s];return r.splice(e,1),r}))},handleInputFocus:()=>{i.length>=3&&n.length>0&&b(!0)},handleInputBlur:()=>{setTimeout((()=>{b(!1)}),200)}}};
//# sourceMappingURL=index.cjs.js.map
