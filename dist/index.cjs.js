"use strict";var e=require("react/jsx-runtime"),r=require("react"),a=require("axios");const o=["9 de Julio","Rivadavia","Corrientes","Santa Fe","Córdoba","del Libertador","de Mayo","Pueyrredón","Callao","San Juan","Belgrano","Independencia","Entre Ríos","Leandro N. Alem","Juan B. Justo","Scalabrini Ortiz","Federico Lacroze","Alvear","Las Heras","General Paz"],s=e=>{const r=o.find((r=>e.toLowerCase().includes(r.toLowerCase())));return r?`${t(r)} Av.`:t(e)},t=e=>e.toLowerCase().split(" ").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" "),n="https://servicios.usig.buenosaires.gob.ar";class i{debug;maxSuggestions;lastRequest;serverTimeout;constructor(e={}){this.debug=e.debug||!1,this.maxSuggestions=e.maxSuggestions||10,this.serverTimeout=e.serverTimeout||5e3,this.lastRequest=null}abort(){this.lastRequest&&(this.lastRequest.abort(),this.lastRequest=null,this.debug&&console.debug("Request aborted"))}async normalizar(e,r=this.maxSuggestions){this.debug&&console.debug(`ApiNormalizer.normalizar('${e}', ${r})`),this.abort(),this.lastRequest=new AbortController;try{let a=[];const o=await this.searchAddresses(e,r);a=[...a,...o];const s=this.parseCoordinates(e);if(s){const e=await this.reverseGeocode(s.x,s.y);a=[...a,...e]}return a.slice(0,r)}catch(e){return a.isCancel(e)?this.debug&&console.debug("Request was cancelled"):console.error("Error normalizing address:",e),[]}finally{this.lastRequest=null}}async searchAddresses(e,r){try{const o=/\s[ye]\s/i,s=o.test(e),t=e.split(o).map((e=>e.trim().toUpperCase()));if(s&&2===t.length){const[e,r]=t,a=await this.obtenerCoordenadasInterseccion(e,r);if(!a)return[];const o=await this.obtenerBarrioYComuna(a.y,a.x),s={codigo:e,nombre:e,tipo:"CALLE",alturas:[]},n={codigo:r,nombre:r,tipo:"CALLE",alturas:[]};return[{tipo:"DIRECCION",nombre:a.x&&a.y?`${e} y ${r}`:"La calle no fue encontrada",tipoDireccion:"DIRECCION_CALLE_Y_CALLE",calle:s,calleCruce:n,coordenadas:{x:a.x,y:a.y,srid:4326},barrio:o.barrio,comuna:o.comuna}]}const i=`${n}/normalizar/?direccion=${encodeURIComponent(e)}&geocodificar=true&max=${r}`,c={headers:{Accept:"application/json"},signal:this.lastRequest?.signal,timeout:this.serverTimeout},d=await a.get(i,c);if(d.data.error)return this.debug&&console.error("API error:",d.data.error),[];if(d.data.direccionesNormalizadas&&d.data.direccionesNormalizadas.length>0){const e=d.data.direccionesNormalizadas.filter((e=>{const r=e.cod_partido?.toLowerCase(),a=e.nombre_partido?.toLowerCase(),o=e.nombre_localidad?.toLowerCase();return"caba"===r||"caba"===a||"caba"===o})),r=await Promise.all(e.map((async e=>{const r=await this.obtenerCoordenadas(e.nombre_calle??"",Number(e.altura??0));if(r){const{barrio:a,comuna:o}=await this.obtenerBarrioYComuna(r.y,r.x),s={codigo:e.cod_calle??"",nombre:e.nombre_calle??"",tipo:"CALLE",alturas:[]},t={x:r.x,y:r.y,srid:r.srid??4326};return{tipo:"DIRECCION",nombre:s.nombre,tipoDireccion:"DIRECCION_CALLE_ALTURA",calle:s,altura:Number(e.altura??0),coordenadas:t,barrio:a,comuna:o,cod_calle:e.cod_calle??""}}return e})));return this.processDireccionesNormalizadas(r)}return d.data.calles&&d.data.calles.length>0?this.processCalles(d.data.calles):[]}catch(e){return a.isCancel(e)?this.debug&&console.debug("Address search request was cancelled"):console.error("Error searching addresses:",e),[]}}async obtenerBarrioYComuna(e,r){try{const o=`https://ws.usig.buenosaires.gob.ar/datos_utiles/?x=${r}&y=${e}`,s=(await a.get(o)).data,t=s?.barrio,n=s?.comuna;return{barrio:t,comuna:n}}catch(e){return console.error("Error al obtener barrio y comuna:",e),{}}}obtenerCoordenadasInterseccion=async(e,r)=>{try{const o=s(e),t=s(r),n=`https://ws.usig.buenosaires.gob.ar/geocoder/2.2/geocoding?cod_calle1=${encodeURIComponent(o.toLocaleUpperCase())}&cod_calle2=${encodeURIComponent(t.toLocaleUpperCase())}`,i=await a.get(n),c=i.data.replace(/^\(|\)$/g,""),d=JSON.parse(c),{x:l,y:u}=d;return{x:l,y:u}}catch(e){return console.error("Error al obtener las coordenadas de la intersección:",e),null}};async obtenerCoordenadas(e,r){try{const o=`https://ws.usig.buenosaires.gob.ar/geocoder/2.2/geocoding?cod_calle=${encodeURIComponent(e)}&altura=${r}`,s=await a.get(o),t=s.data.replace(/^\(|\)$/g,""),n=JSON.parse(t),{x:i,y:c}=n,d=`https://ws.usig.buenosaires.gob.ar/rest/convertir_coordenadas/?x=${i}&y=${c}&output=lonlat`,l=await a.get(d),{x:u,y:m}=l.data.resultado;return{y:m,x:u}}catch(e){return console.error("Error al obtener coordenadas:",e),null}}parseCoordinates(e){const r=e.trim().replace(/\s+/g,""),a=[/^(-?\d+\.?\d*),(-?\d+\.?\d*)$/,/x:?(-?\d+\.?\d*)[,\s]+y:?(-?\d+\.?\d*)/i,/y:?(-?\d+\.?\d*)[,\s]+x:?(-?\d+\.?\d*)/i];for(const e of a){const o=r.match(e);if(o){if(e===a[0])return{y:Number.parseFloat(o[1]),x:Number.parseFloat(o[2])};if(e===a[1])return{x:Number.parseFloat(o[1]),y:Number.parseFloat(o[2])};if(e===a[2])return{y:Number.parseFloat(o[1]),x:Number.parseFloat(o[2])}}}return null}async reverseGeocode(e,r){this.debug&&console.debug(`ApiNormalizer.reverseGeocode(${e}, ${r})`),this.abort(),this.lastRequest=new AbortController;try{const o=`${n}/reverseGeocoderLugares/?x=${e}&y=${r}&srid=4326`,s={headers:{Accept:"application/json"},signal:this.lastRequest.signal,timeout:this.serverTimeout},t=await a.get(o,s);if(t.data.error)return this.debug&&console.error("Reverse geocoding API error:",t.data.error),[];if(!t.data.direccion)return[];const i={codigo:t.data.cod_calle||"coord",nombre:t.data.nombre||t.data.direccion||"Coordenada",descripcion:t.data.direccion||"Coordenada",tipo:"CALLE",alturas:[{inicio:1,fin:1e4}]};let c=0;t.data.altura&&(c=Number(t.data.altura));return[{calle:i,altura:c||1,tipoDireccion:"DIRECCION_CALLE_ALTURA",tipo:"DIRECCION",nombre:t.data.direccion||`Coordenada (${e.toFixed(6)}, ${r.toFixed(6)})`,descripcion:`Coordenada (${e.toFixed(6)}, ${r.toFixed(6)})`,coordenadas:{x:e,y:r,srid:t.data.coordenadas?.srid||4326},barrio:t.data.nombre_barrio,comuna:t.data.nombre_comuna}]}catch(e){return a.isCancel(e)?this.debug&&console.debug("Reverse geocoding request was cancelled"):console.error("Error in reverse geocoding:",e),[]}finally{this.lastRequest=null}}processDireccionesNormalizadas(e){if(!e)return Promise.resolve([]);const r=e.map((async e=>{if(!e.nombre||!e.cod_calle)return null;const r={codigo:e.cod_calle,nombre:e.nombre||e.nombre_calle||"",descripcion:e.direccion,tipo:"CALLE",alturas:[{inicio:1,fin:1e4}]};let a;if(e.nombre.includes(" y ")){const o=e.nombre.split(" y ").map((e=>e.trim()));a={calle:r,calleCruce:{codigo:`${e.cod_calle}_cruce`,nombre:o[1]||"Calle cruce",descripcion:o[1]||"Calle cruce",tipo:"CALLE",alturas:[{inicio:1,fin:1e4}]},tipoDireccion:"DIRECCION_CALLE_Y_CALLE",tipo:"DIRECCION",nombre:e.nombre,descripcion:`Coordenada (${e.coordenadas?.x.toFixed(6)}, ${e.coordenadas?.y.toFixed(6)})`,coordenadas:e.coordenadas?{x:e.coordenadas.x,y:e.coordenadas.y,srid:e.coordenadas.srid}:void 0,barrio:e.barrio,comuna:e.comuna,altura:Number(e.altura),smp:void 0}}else if(a={calle:r,altura:Number(e.altura),tipoDireccion:"DIRECCION_CALLE_ALTURA",tipo:"DIRECCION",nombre:`${e.nombre} ${e.altura}`,descripcion:e.direccion,coordenadas:e.coordenadas?{x:e.coordenadas.x,y:e.coordenadas.y,srid:e.coordenadas.srid}:void 0,barrio:e.barrio,comuna:e.comuna,calleCruce:void 0,smp:void 0},Number(e.altura)>0)try{const r=await this.getSMP({nombre:e.nombre_calle||"",descripcion:e.nombre||"",tipo:"DIRECCION",codigo:e.cod_calle,altura:e.altura,calle:{codigo:e.cod_calle}});a.smp=r??"",a.altura=Number(e.altura),a.descripcion=e.nombre}catch(e){this.debug&&console.error("Error getting SMP:",e)}return a}));return Promise.all(r).then((e=>e.filter(Boolean)))}processCalles(e){return e?e.map((e=>({codigo:e.cod_calle,nombre:e.nombre,descripcion:e.tipo?`${e.tipo} ${e.nombre}`:e.nombre,tipo:"CALLE",alturas:[{inicio:e.altura?.inicial||1,fin:e.altura?.final||1e4}],partido:e.partido,localidad:e.localidad}))):[]}async getCoordinates(e){try{this.abort(),this.lastRequest=new AbortController;const r=`${n}/normalizar/?direccion=${encodeURIComponent(e.nombre)},${encodeURIComponent(e.descripcion)}&geocodificar=true&srid=4326`,o={headers:{Accept:"application/json"},signal:this.lastRequest.signal,timeout:this.serverTimeout},s=await a.get(r,o),t=s.data.direccionesNormalizadas?.[0];if(t?.coordenadas){const e=t.coordenadas;return{x:e.x,y:e.y,srid:e.srid}}return}catch(e){return void(a.isCancel(e)?this.debug&&console.debug("Request was aborted"):console.error("Error fetching coordinates:",e))}finally{this.lastRequest=null}}async getSMP(e){try{this.abort(),this.lastRequest=new AbortController;const r=e.codigo||e.calle?.codigo;if(!r||!e.altura)return;const o=`https://epok.buenosaires.gob.ar/catastro/parcela/?codigo_calle=${encodeURIComponent(r)}&altura=${encodeURIComponent(String(e.altura))}&geocodificar=true&srid=4326`,s={headers:{Accept:"application/json"},signal:this.lastRequest.signal,timeout:this.serverTimeout};return(await a.get(o,s)).data.smp}catch(e){return void(a.isCancel(e)?this.debug&&console.debug("Request was aborted"):console.error("Error fetching catastro data:",e))}finally{this.lastRequest=null}}static inicializado(){return!0}}const c=({className:r="",size:a=24,color:o="currentColor"})=>e.jsx("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",stroke:o,strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:r,children:e.jsx("path",{d:"M21 12a9 9 0 1 1-6.219-8.56"})}),d=({className:r="",size:a=24,color:o="currentColor"})=>e.jsx("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",stroke:o,strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:r,children:e.jsx("polygon",{points:"3,11 22,2 13,21 11,13 3,11"})});exports.AddressSearch=({maxSuggestions:a=10,onAddressSelect:o,onAddressesRemove:s,placeholder:t="Buscar dirección o coordenadas...",debug:n=!1,className:l="",inputClassName:u="",selectedAddresses:m=[],suggestionsClassName:g="",suggestionItemClassName:p="",selectedAddressesClassName:b="",loadingClassName:h="",suggestionsContainerClassName:x="",selectedAddressesContainerClassName:C="",selectedAddressItemClassName:y="",removeButtonClassName:N="",errorClassName:f="",iconClassName:L="",titleClassName:A="",coordsClassName:v="",smpClassName:$="",serverTimeout:w=5e3,containerItemsClass:R="",isDebug:E=!1})=>{const[j,I]=r.useState(""),[_,S]=r.useState([]),[D,T]=r.useState(!1),[F,q]=r.useState(!1),[z,B]=r.useState(null),U=r.useRef(null),O=r.useRef(null);r.useEffect((()=>(O.current=new i({debug:n,maxSuggestions:a,serverTimeout:w}),()=>{U.current&&clearTimeout(U.current),O.current&&O.current.abort()})),[n,a,w]);const k=e=>"CALLE"===e.tipo?{title:e.nombre,subTitle:e.descripcion||"CABA",type:"CALLE",category:"CALLE",suggesterName:"Direcciones",data:{nombre:e.nombre,descripcion:e.descripcion||"",tipo:"CALLE",codigo:e.codigo}}:{title:e.nombre,subTitle:e.descripcion||"CABA",type:e.tipoDireccion,category:e.tipoDireccion,suggesterName:"Direcciones",data:{nombre:e.nombre,descripcion:e.descripcion||"",tipo:e.tipo,codigo:e.calle.codigo,altura:"DIRECCION_CALLE_ALTURA"===e.tipoDireccion?e.altura:void 0,calle:{codigo:e.calle.codigo},coordenadas:e.coordenadas,smp:e.smp,barrio:e.barrio,comuna:e.comuna}},P=r.useCallback((async e=>{if(n&&console.debug(`getSuggestions('${e}')`),!O.current||!e||e.length<3)S([]);else try{T(!0),B(null);const r=(await O.current.normalizar(e,a)).map(k);S(r),q(!0),0===r.length&&B("No se encontraron resultados")}catch(e){console.error("Error getting suggestions:",e),S([]),B("Error al buscar direcciones")}finally{T(!1)}}),[n,a]);return e.jsxs("div",{className:`w-full ${l}`,children:[e.jsxs("div",{className:"relative max-w-[500px]",children:[e.jsx("input",{type:"text",value:j,onChange:e=>{const r=e.target.value;I(r),B(null),U.current&&clearTimeout(U.current),O.current&&O.current.abort(),r.length>=3?(q(!0),T(!0),U.current=setTimeout((()=>{P(r)}),300)):(S([]),q(!1),T(!1))},onFocus:()=>{j.length>=3&&q(!0)},onBlur:()=>{setTimeout((()=>{q(!1)}),200)},placeholder:t,className:`w-full h-[24px] p-[8px] border rounded ${u}`}),D&&e.jsx("div",{className:`absolute right-[0] top-1/2 transform -translate-y-1/2 ${h}`,children:e.jsx(c,{className:"h-4 w-4 text-gray-500 animate-spin"})}),(F||D)&&e.jsx("div",{className:`absolute z-10 w-full bg-[#FFFFFF] border border-t-0 rounded shadow-lg max-h-[200px] overflow-auto px-[8px] ${x}`,children:D?e.jsxs("div",{className:`p-[8px] flex items-center justify-center gap-[8px] text-gray-500  ${g}`,children:[e.jsx(c,{className:"h-5 w-2 animate-spin mb-2"}),e.jsx("span",{children:"Buscando direcciones..."})]}):_.length>0?_.map(((r,a)=>e.jsx("div",{className:`my-[8px] border-b border-[#b8b5b4] last:border-b-0 cursor-pointer hover:bg-[#dfe0e1] transition duration-300 ease-in-out bg-white rounded-[4px] w-[100%] ${p}`,onClick:()=>{r.data.coordenadas&&r.data.coordenadas.x&&r.data.coordenadas.y&&(e=>{m.some((r=>r.data.nombre===e.data.nombre))||o(e),I(""),S([]),q(!1)})(r)},children:e.jsxs("div",{className:"flex items-center gap-[8px]",children:[e.jsx("div",{children:e.jsx(d,{className:`h-4 text-[#0042ff] ${L}`})}),e.jsxs("div",{className:"flex flex-center gap-[8px]",children:[e.jsxs("span",{className:`font-medium text-[14px] truncate ${A}`,children:[r.title,"."]}),r.data.coordenadas&&r.data.coordenadas.x&&r.data.coordenadas.y&&e.jsxs("span",{className:`text-xs text-gray-400 truncate ${v}`,children:["Coord: ",r.data.coordenadas.x,","," ",r.data.coordenadas.y]}),r.data.smp&&e.jsxs("span",{className:`text-xs text-gray-400 ${$}`,children:["SMP: ",r.data.smp]})]})]})},`${r.data.nombre}-${a}`))):j.length>=3?e.jsx("div",{className:`p-[8px] text-center text-red-500 ${f}`,children:z||"No se encontraron resultados"}):e.jsx("div",{className:`p-4 text-center text-gray-500 ${g}`,children:"Ingrese al menos 3 caracteres para buscar"})}),z&&!D&&!F&&e.jsx("div",{className:`mt-[8px] text-sm text-red-500 ${f}`,children:z})]}),E&&e.jsx(e.Fragment,{children:m.length>0&&e.jsxs("div",{className:`${b} ${C}`,children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"Direcciones seleccionadas:"}),e.jsx("ul",{className:"space-y-2",children:m.map(((r,a)=>e.jsxs("li",{className:`flex justify-between items-center p-2 bg-gray-50 rounded ${y}`,children:[e.jsxs("div",{className:`flex items-center gap-[8px] ${R}`,children:[e.jsx("div",{className:"mt-1",children:e.jsx(d,{className:`h-4 w-4 text-[#0042ff] ${L}`})}),e.jsxs("div",{className:"flex flex-center gap-[8px]",children:[e.jsxs("div",{className:`font-medium ${A}`,children:[r.title,"."]}),r.data.coordenadas&&e.jsxs("div",{className:`text-xs text-gray-400 ${v}`,children:["Coord: ",r.data.coordenadas.x.toFixed(6),","," ",r.data.coordenadas.y.toFixed(6)]}),r.data.smp&&e.jsxs("div",{className:`text-xs text-gray-400 ${$}`,children:["SMP: ",r.data.smp]})]})]}),e.jsx("button",{type:"button",onClick:()=>(e=>{s(e)})(a),className:`text-[#FFF] bg-[#ff0000] rounded-[4px] border-0 h-[24px] w-[24px] cursor-pointer transition duration-300 ease-in-out hover:scale-125 ${N}`,children:"×"})]},`selected-${a}`)))})]})})]})},exports.useAddressSearch=function(e={}){const{maxSuggestions:a=10,debug:o=!1,serverTimeout:s=5e3}=e,[t,n]=r.useState(""),[c,d]=r.useState([]),[l,u]=r.useState([]),[m,g]=r.useState(!1),[p,b]=r.useState(null),[h,x]=r.useState(!1),C=r.useRef(null),y=r.useRef(null);r.useEffect((()=>(y.current=new i({debug:o,maxSuggestions:a,serverTimeout:s}),()=>{C.current&&clearTimeout(C.current),y.current&&y.current.abort()})),[o,a,s]);const N=e=>"CALLE"===e.tipo?{title:e.nombre,subTitle:e.descripcion||"CABA",type:"CALLE",category:"CALLE",suggesterName:"Direcciones",data:{nombre:e.nombre,descripcion:e.descripcion||"",tipo:"CALLE",codigo:e.codigo}}:{title:e.nombre,subTitle:e.descripcion||"CABA",type:e.tipoDireccion,category:e.tipoDireccion,suggesterName:"Direcciones",data:{nombre:e.nombre,descripcion:e.descripcion||"",tipo:e.tipo,codigo:e.calle.codigo,altura:"DIRECCION_CALLE_ALTURA"===e.tipoDireccion?e.altura:void 0,calle:{codigo:e.calle.codigo},coordenadas:e.coordenadas,smp:e.smp}},f=r.useCallback((async e=>{if(o&&console.debug(`fetchSuggestions('${e}')`),!y.current||!e||e.length<3)d([]);else try{g(!0),b(null);const r=(await y.current.normalizar(e,a)).map(N);d(r),0===r.length&&b("No se encontraron resultados")}catch(e){console.error("Error getting suggestions:",e),d([]),b("Error al buscar direcciones")}finally{g(!1)}}),[o,a]);return{searchText:t,setSearchText:n,suggestions:c,selectedAddresses:l,isLoading:m,error:p,showSuggestions:h,setShowSuggestions:x,handleInputChange:e=>{const r=e.target.value;n(r),b(null),C.current&&clearTimeout(C.current),y.current&&y.current.abort(),r.length>=3?C.current=setTimeout((()=>{f(r)}),3e3):d([])},handleSelectSuggestion:e=>{l.some((r=>r.data.nombre===e.data.nombre))||u((r=>[...r,e])),n(""),d([]),x(!1)},handleRemoveAddress:e=>{u((r=>{const a=[...r];return a.splice(e,1),a}))},handleInputFocus:()=>{t.length>=3&&c.length>0&&x(!0)},handleInputBlur:()=>{setTimeout((()=>{x(!1)}),200)}}};
//# sourceMappingURL=index.cjs.js.map
