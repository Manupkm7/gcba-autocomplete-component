import{jsx as e,jsxs as r}from"react/jsx-runtime";import{useState as t,useRef as o,useEffect as a,useCallback as s}from"react";import i from"axios";const c="https://servicios.usig.buenosaires.gob.ar";class n{debug;maxSuggestions;lastRequest;serverTimeout;constructor(e={}){this.debug=e.debug||!1,this.maxSuggestions=e.maxSuggestions||10,this.serverTimeout=e.serverTimeout||5e3,this.lastRequest=null}abort(){this.lastRequest&&(this.lastRequest.abort(),this.lastRequest=null,this.debug&&console.debug("Request aborted"))}async normalizar(e,r=this.maxSuggestions){this.debug&&console.debug(`ApiNormalizer.normalizar('${e}', ${r})`),this.abort(),this.lastRequest=new AbortController;try{let t=[];const o=await this.searchAddresses(e,r);t=[...t,...o];const a=this.parseCoordinates(e);if(a){const e=await this.reverseGeocode(a.x,a.y);t=[...t,...e]}return t.slice(0,r)}catch(e){return i.isCancel(e)?this.debug&&console.debug("Request was cancelled"):console.error("Error normalizing address:",e),[]}finally{this.lastRequest=null}}async searchAddresses(e,r){try{const t=`${c}/normalizar/?direccion=${encodeURIComponent(e)}&geocodificar=true&max=${r}`,o={headers:{Accept:"application/json"},signal:this.lastRequest?.signal,timeout:this.serverTimeout},a=await i.get(t,o);return a.data.error?(this.debug&&console.error("API error:",a.data.error),[]):a.data.direccionesNormalizadas&&a.data.direccionesNormalizadas.length>0?this.processDireccionesNormalizadas(a.data.direccionesNormalizadas):a.data.calles&&a.data.calles.length>0?this.processCalles(a.data.calles):[]}catch(e){return i.isCancel(e)?this.debug&&console.log("Address search request was cancelled"):console.error("Error searching addresses:",e),[]}}parseCoordinates(e){const r=e.trim().replace(/\s+/g,""),t=[/^(-?\d+\.?\d*),(-?\d+\.?\d*)$/,/x:?(-?\d+\.?\d*)[,\s]+y:?(-?\d+\.?\d*)/i,/y:?(-?\d+\.?\d*)[,\s]+x:?(-?\d+\.?\d*)/i];for(const e of t){const o=r.match(e);if(o){if(e===t[0])return{y:Number.parseFloat(o[1]),x:Number.parseFloat(o[2])};if(e===t[1])return{x:Number.parseFloat(o[1]),y:Number.parseFloat(o[2])};if(e===t[2])return{y:Number.parseFloat(o[1]),x:Number.parseFloat(o[2])}}}return null}async reverseGeocode(e,r){this.debug&&console.debug(`ApiNormalizer.reverseGeocode(${e}, ${r})`),this.abort(),this.lastRequest=new AbortController;try{const t=`${c}/reverseGeocoderLugares/?x=${e}&y=${r}&srid=4326`,o={headers:{Accept:"application/json"},signal:this.lastRequest.signal,timeout:this.serverTimeout},a=await i.get(t,o);if(a.data.error)return this.debug&&console.error("Reverse geocoding API error:",a.data.error),[];if(!a.data.direccion)return[];const s={codigo:a.data.cod_calle||"coord",nombre:a.data.nombre||a.data.direccion||"Coordenada",descripcion:a.data.direccion||"Coordenada",tipo:"CALLE",alturas:[{inicio:1,fin:1e4}]};let n=0;a.data.altura&&(n=Number.parseInt(a.data.altura,10));return[{calle:s,altura:n||1,tipoDireccion:"DIRECCION_CALLE_ALTURA",tipo:"DIRECCION",nombre:a.data.direccion||`Coordenada (${e.toFixed(6)}, ${r.toFixed(6)})`,descripcion:`Coordenada (${e.toFixed(6)}, ${r.toFixed(6)})`,coordenadas:{x:e,y:r,srid:a.data.coordenadas?.srid||4326}}]}catch(e){return i.isCancel(e)?this.debug&&console.log("Reverse geocoding request was cancelled"):console.error("Error in reverse geocoding:",e),[]}finally{this.lastRequest=null}}processDireccionesNormalizadas(e){if(!e)return Promise.resolve([]);const r=e.map((async e=>{if(!e.direccion||!e.cod_calle)return null;const r={codigo:e.cod_calle,nombre:e.nombre||e.direccion.split(" ")[0],descripcion:e.direccion,tipo:"CALLE",alturas:[{inicio:1,fin:1e4}]};let t;if(e.direccion.includes(" y ")){const o=e.direccion.split(" y ").map((e=>e.trim()));t={calle:r,calleCruce:{codigo:`${e.cod_calle}_cruce`,nombre:o[1]||"Calle cruce",descripcion:o[1]||"Calle cruce",tipo:"CALLE",alturas:[{inicio:1,fin:1e4}]},tipoDireccion:"DIRECCION_CALLE_Y_CALLE",tipo:"DIRECCION",nombre:e.direccion,descripcion:e.direccion,coordenadas:e.coordenadas?{x:Number.parseFloat(e.coordenadas.x),y:Number.parseFloat(e.coordenadas.y),srid:e.coordenadas.srid}:void 0}}else{const o=e.altura?Number.parseInt(e.altura,10):0;if(t={calle:r,altura:o,tipoDireccion:"DIRECCION_CALLE_ALTURA",tipo:"DIRECCION",nombre:e.direccion,descripcion:e.direccion,coordenadas:e.coordenadas?{x:Number.parseFloat(e.coordenadas.x),y:Number.parseFloat(e.coordenadas.y),srid:e.coordenadas.srid}:void 0},o>0)try{const r=await this.getSMP({nombre:e.direccion,descripcion:e.direccion||"",tipo:"DIRECCION",codigo:e.cod_calle,altura:e.altura,calle:{codigo:e.cod_calle}});r&&(t.smp=r)}catch(e){this.debug&&console.error("Error getting SMP:",e)}}return t}));return Promise.all(r).then((e=>e.filter(Boolean)))}processCalles(e){return e?e.map((e=>({codigo:e.cod_calle,nombre:e.nombre,descripcion:e.tipo?`${e.tipo} ${e.nombre}`:e.nombre,tipo:"CALLE",alturas:[{inicio:e.altura?.inicial||1,fin:e.altura?.final||1e4}],partido:e.partido,localidad:e.localidad}))):[]}async getCoordinates(e){try{this.abort(),this.lastRequest=new AbortController;const r=`${c}/normalizar/?direccion=${encodeURIComponent(e.nombre)},${encodeURIComponent(e.descripcion)}&geocodificar=true&srid=4326`,t={headers:{Accept:"application/json"},signal:this.lastRequest.signal,timeout:this.serverTimeout},o=await i.get(r,t),a=o.data.direccionesNormalizadas?.[0];if(a?.coordenadas){const e=a.coordenadas;return{x:Number.parseFloat(e.x),y:Number.parseFloat(e.y),srid:e.srid}}return}catch(e){return void(i.isCancel(e)?this.debug&&console.debug("Request was aborted"):console.error("Error fetching coordinates:",e))}finally{this.lastRequest=null}}async getSMP(e){try{this.abort(),this.lastRequest=new AbortController;const r=e.codigo||e.calle?.codigo;if(!r||!e.altura)return;const t=`https://epok.buenosaires.gob.ar/catastro/parcela/?codigo_calle=${encodeURIComponent(r)}&altura=${encodeURIComponent(String(e.altura))}&geocodificar=true&srid=4326`,o={headers:{Accept:"application/json"},signal:this.lastRequest.signal,timeout:this.serverTimeout};return(await i.get(t,o)).data.smp}catch(e){return void(i.isCancel(e)?this.debug&&console.log("Request was aborted"):console.error("Error fetching catastro data:",e))}finally{this.lastRequest=null}}static inicializado(){return!0}}const l=({className:r="",size:t=24,color:o="currentColor"})=>e("svg",{width:t,height:t,viewBox:"0 0 24 24",fill:"none",stroke:o,strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:r,children:e("path",{d:"M21 12a9 9 0 1 1-6.219-8.56"})}),d=({className:r="",size:t=24,color:o="currentColor"})=>e("svg",{width:t,height:t,viewBox:"0 0 24 24",fill:"none",stroke:o,strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:r,children:e("polygon",{points:"3,11 22,2 13,21 11,13 3,11"})}),u=({maxSuggestions:i=10,onAddressSelect:c,onAddressesRemove:u,placeholder:m="Buscar dirección o coordenadas...",debug:g=!1,className:p="",inputClassName:h="",selectedAddresses:b=[],suggestionsClassName:C="",suggestionItemClassName:N="",selectedAddressesClassName:x="",loadingClassName:y="",suggestionsContainerClassName:v="",selectedAddressesContainerClassName:A="",selectedAddressItemClassName:f="",removeButtonClassName:$="",errorClassName:L="",iconClassName:R="",titleClassName:E="",subtitleClassName:w="",coordsClassName:I="",smpClassName:T="",serverTimeout:D=5e3})=>{const[q,S]=t(""),[F,_]=t([]),[z,B]=t(!1),[k,O]=t(!1),[P,U]=t(null),j=o(null),M=o(null);a((()=>(M.current=new n({debug:g,maxSuggestions:i,serverTimeout:D}),()=>{j.current&&clearTimeout(j.current),M.current&&M.current.abort()})),[g,i,D]);const G=e=>"CALLE"===e.tipo?{title:e.nombre,subTitle:e.descripcion||"CABA",type:"CALLE",category:"CALLE",suggesterName:"Direcciones",data:{nombre:e.nombre,descripcion:e.descripcion||"",tipo:"CALLE",codigo:e.codigo}}:{title:e.nombre,subTitle:e.descripcion||"CABA",type:e.tipoDireccion,category:e.tipoDireccion,suggesterName:"Direcciones",data:{nombre:e.nombre,descripcion:e.descripcion||"",tipo:e.tipo,codigo:e.calle.codigo,altura:"DIRECCION_CALLE_ALTURA"===e.tipoDireccion?e.altura:void 0,calle:{codigo:e.calle.codigo},coordenadas:e.coordenadas,smp:e.smp}},W=s((async e=>{if(g&&console.debug(`getSuggestions('${e}')`),!M.current||!e||e.length<3)_([]);else try{B(!0),U(null);const r=(await M.current.normalizar(e,i)).map(G);_(r),O(!0),0===r.length&&U("No se encontraron resultados")}catch(e){console.error("Error getting suggestions:",e),_([]),U("Error al buscar direcciones")}finally{B(!1)}}),[g,i]);return r("div",{className:`address-search-container ${p}`,children:[r("div",{className:"relative",children:[e("input",{type:"text",value:q,onChange:e=>{const r=e.target.value;S(r),U(null),j.current&&clearTimeout(j.current),M.current&&M.current.abort(),r.length>=3?(O(!0),B(!0),j.current=setTimeout((()=>{W(r)}),300)):(_([]),O(!1),B(!1))},onFocus:()=>{q.length>=3&&O(!0)},onBlur:()=>{setTimeout((()=>{O(!1)}),200)},placeholder:m,className:`w-full p-2 border rounded ${h}`}),z&&e("div",{className:`absolute right-2 top-1/2 transform -translate-y-1/2 ${y}`,children:e(l,{className:"h-4 w-4 text-gray-500 animate-spin"})}),(k||z)&&e("ul",{className:`absolute z-10 w-full mt-1 bg-white border rounded shadow-lg max-h-60 overflow-auto ${v}`,children:z?r("li",{className:`p-4 text-center text-gray-500 ${C}`,children:[e(l,{className:"h-5 w-5 mx-auto animate-spin mb-2"}),e("span",{children:"Buscando direcciones..."})]}):F.length>0?F.map(((t,o)=>e("li",{className:`p-2 cursor-pointer hover:bg-gray-100 ${N}`,onClick:()=>(e=>{b.some((r=>r.data.nombre===e.data.nombre))||c(e),S(""),_([]),O(!1)})(t),children:r("div",{className:"flex items-start gap-2",children:[e("div",{className:"mt-1",children:e(d,{className:`h-4 w-4 text-blue-500 ${R}`})}),r("div",{className:"flex-1",children:[e("div",{className:`font-medium ${E}`,children:t.title}),e("div",{className:`text-sm text-gray-500 ${w}`,children:t.subTitle}),t.data.coordenadas&&r("div",{className:`text-xs text-gray-400 ${I}`,children:["Coord: ",t.data.coordenadas.x.toFixed(6),","," ",t.data.coordenadas.y.toFixed(6)]}),t.data.smp&&r("div",{className:`text-xs text-gray-400 ${T}`,children:["SMP: ",t.data.smp]})]})]})},`${t.data.nombre}-${o}`))):q.length>=3?e("li",{className:`p-4 text-center text-red-500 ${L}`,children:P||"No se encontraron resultados"}):e("li",{className:`p-4 text-center text-gray-500 ${C}`,children:"Ingrese al menos 3 caracteres para buscar"})}),P&&!z&&!k&&e("div",{className:`mt-1 text-sm text-red-500 ${L}`,children:P})]}),b.length>0&&r("div",{className:`mt-4 ${x} ${A}`,children:[e("h3",{className:"text-sm font-medium mb-2",children:"Direcciones seleccionadas:"}),e("ul",{className:"space-y-2",children:b.map(((t,o)=>r("li",{className:`flex justify-between items-center p-2 bg-gray-50 rounded ${f}`,children:[r("div",{className:"flex items-start gap-2",children:[e("div",{className:"mt-1",children:e(d,{className:`h-4 w-4 text-blue-500 ${R}`})}),r("div",{children:[e("div",{className:`font-medium ${E}`,children:t.title}),e("div",{className:`text-sm text-gray-500 ${w}`,children:t.subTitle}),t.data.coordenadas&&r("div",{className:`text-xs text-gray-400 ${I}`,children:["Coord: ",t.data.coordenadas.x.toFixed(6),","," ",t.data.coordenadas.y.toFixed(6)]}),t.data.smp&&r("div",{className:`text-xs text-gray-400 ${T}`,children:["SMP: ",t.data.smp]})]})]}),e("button",{type:"button",onClick:()=>(e=>{u(e)})(o),className:`text-red-500 hover:text-red-700 ${$}`,children:"×"})]},`selected-${o}`)))})]})]})};function m(e={}){const{maxSuggestions:r=10,debug:i=!1,serverTimeout:c=5e3}=e,[l,d]=t(""),[u,m]=t([]),[g,p]=t([]),[h,b]=t(!1),[C,N]=t(null),[x,y]=t(!1),v=o(null),A=o(null);a((()=>(A.current=new n({debug:i,maxSuggestions:r,serverTimeout:c}),()=>{v.current&&clearTimeout(v.current),A.current&&A.current.abort()})),[i,r,c]);const f=e=>"CALLE"===e.tipo?{title:e.nombre,subTitle:e.descripcion||"CABA",type:"CALLE",category:"CALLE",suggesterName:"Direcciones",data:{nombre:e.nombre,descripcion:e.descripcion||"",tipo:"CALLE",codigo:e.codigo}}:{title:e.nombre,subTitle:e.descripcion||"CABA",type:e.tipoDireccion,category:e.tipoDireccion,suggesterName:"Direcciones",data:{nombre:e.nombre,descripcion:e.descripcion||"",tipo:e.tipo,codigo:e.calle.codigo,altura:"DIRECCION_CALLE_ALTURA"===e.tipoDireccion?e.altura:void 0,calle:{codigo:e.calle.codigo},coordenadas:e.coordenadas,smp:e.smp}},$=s((async e=>{if(i&&console.log(`fetchSuggestions('${e}')`),!A.current||!e||e.length<3)m([]);else try{b(!0),N(null);const t=(await A.current.normalizar(e,r)).map(f);m(t),0===t.length&&N("No se encontraron resultados")}catch(e){console.error("Error getting suggestions:",e),m([]),N("Error al buscar direcciones")}finally{b(!1)}}),[i,r]);return{searchText:l,setSearchText:d,suggestions:u,selectedAddresses:g,isLoading:h,error:C,showSuggestions:x,setShowSuggestions:y,handleInputChange:e=>{const r=e.target.value;d(r),N(null),v.current&&clearTimeout(v.current),A.current&&A.current.abort(),r.length>=3?v.current=setTimeout((()=>{$(r)}),300):m([])},handleSelectSuggestion:e=>{g.some((r=>r.data.nombre===e.data.nombre))||p((r=>[...r,e])),d(""),m([]),y(!1)},handleRemoveAddress:e=>{p((r=>{const t=[...r];return t.splice(e,1),t}))},handleInputFocus:()=>{l.length>=3&&u.length>0&&y(!0)},handleInputBlur:()=>{setTimeout((()=>{y(!1)}),200)}}}export{u as AddressSearch,m as useAddressSearch};
//# sourceMappingURL=index.esm.js.map
